---
author: simon.jonassen@gmail.com
comments: true
date: 2016-12-01 21:15:00+01:00
layout: post
title: Having fun with Scikit-Learn
tags: [machine learning, programming, python, scikit-learn]
share: true
---
[Scikit-Learn](http://scikit-learn.org/) is a really great library to start machine learning with, because it combines a powerful API, solid documentation, and a large variety of methods with lots of different options and sensible defaults. For example, if we have a classification problem of predicting whether a sentence is about New-York, London or both, we can create a pipeline including tokenization with case folding and stop-word removal, bigram extraction, tf-idf weighting and support for multiple labels, train and apply it in merely 8 lines of code (well, excluding imports and input specification).<!--more-->

```python
vec = TfidfVectorizer(ngram_range=(1, 2), stop_words='english', max_features=15)
clf = OneVsRestClassifier(LogisticRegressionCV())
pipeline = make_pipeline(vec, clf)
mlb = MultiLabelBinarizer()
y_train = mlb.fit_transform(y_train)
pipeline.fit(X_train, y_train)
predicted = pipeline.predict(X_test)
print(zip(X_test, mlb.inverse_transform(predicted)))
```

Furthermore, we can easily add cross-validation and parameter tuning, etc., in just a few more lines. Check out [this great introductory video series](http://www.dataschool.io/machine-learning-with-scikit-learn/) for all the cool features you can use right from the beginning. But lets go back a bit! Assume we have the following training data:

<pre>
[("new york is a hell of a town", ["New York"]),
 ("new york was originally dutch", ["New York"]),
 ("the big apple is great", ["New York"]),
 ("new york is also called the big apple", ["New York"]),
 ("nyc is nice", ["New York"]),
 ("people abbreviate new york city as nyc", ["New York"]),
 ("the capital of great britain is london", ["London"]),
 ("london is in the uk", ["London"]),
 ("london is in england", ["London"]),
 ("london is in great britain", ["London"]),
 ("it rains a lot in london", ["London"]),
 ("london hosts the british museum", ["London"]),
 ("new york is great and so is london", ["London", "New York"]),
 ("i like london better than new york", ["London", "New York"])]
</pre>

Our model can easily predict the following:
<pre>
[("nice day in nyc", ["New York"]),
 ("welcome to london", ["London']),
 ("hello simon welcome to new york. enjoy it here and london", ["London", "New York"])]
</pre>

But how? Well, [we know](http://scikit-learn.org/stable/modules/linear_model.html#logistic-regression) that the model's decision computes a dot product between the input features and the trained weights and we can actually see the computed numbers:

```python
print(pipeline.decision_function(X_test))
```

<pre>
[[ -7.96273351   1.04803743]
 [ 22.19686347  -1.39109585]
 [  5.48828931   1.28660432]]
</pre>

So, a positive number indicates positive classification (\[London, New-York\]), and we can convert this to some sort of "probability" estimation:

```python
print(np.vectorize(lambda x: 1 / (1 + exp(-x)))(pipeline.decision_function(X_test)))
```

<pre>
[[  3.48078806e-04   7.40397853e-01]
 [  1.00000000e+00   1.99232868e-01]
 [  9.95882115e-01   7.83571880e-01]]
</pre>

However, it would be nice if we could know exactly which words have contributed to the final score. And guess what, there is [an awesome library](https://github.com/TeamHG-Memex/eli5) to [explain you this like are five years old](http://eli5.readthedocs.io/en/latest/tutorials/sklearn-text.html):

```python
import eli5
eli5.show_prediction(clf, X_test[0], vec=vec, target_names=mlb.classes_)
```

<div class="output_html rendered_html output_subarea output_execute_result"> <p style="margin-bottom: 0.5em; margin-top: 0em"> <b> y=London </b> (probability <b>0.996</b>, score <b>5.488</b>)top features </p> <table class="eli5-weights" style="border-collapse: collapse; border: none; margin-top: 0em; margin-bottom: 2em;"> <thead> <tr style="border: none;"> <th style="padding: 0 1em 0 0.5em; text-align: right; border: none;">Weight</th> <th style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;">Feature</th> </tr> </thead> <tbody> <tr style="background-color: hsl(120, 100.00%, 80.00%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +8.631 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> Highlighted in text (sum) </td></tr> </tbody> </table> <p style="margin-bottom: 2.5em; margin-top:-0.5em;"> <span style="opacity: 0.80">h</span><span style="opacity: 0.80">e</span><span style="opacity: 0.80">l</span><span style="opacity: 0.80">l</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">s</span><span style="opacity: 0.80">i</span><span style="opacity: 0.80">m</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80">n</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">w</span><span style="opacity: 0.80">e</span><span style="opacity: 0.80">l</span><span style="opacity: 0.80">c</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80">m</span><span style="opacity: 0.80">e</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">t</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80"> </span><span style="background-color: hsl(0, 100.00%, 89.16%); opacity: 0.83" title="-1.740">n</span><span style="background-color: hsl(0, 100.00%, 89.16%); opacity: 0.83" title="-1.740">e</span><span style="background-color: hsl(0, 100.00%, 89.16%); opacity: 0.83" title="-1.740">w</span><span style="opacity: 0.80"> </span><span style="background-color: hsl(0, 100.00%, 89.16%); opacity: 0.83" title="-1.740">y</span><span style="background-color: hsl(0, 100.00%, 89.16%); opacity: 0.83" title="-1.740">o</span><span style="background-color: hsl(0, 100.00%, 89.16%); opacity: 0.83" title="-1.740">r</span><span style="background-color: hsl(0, 100.00%, 89.16%); opacity: 0.83" title="-1.740">k</span><span style="opacity: 0.80">.</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">e</span><span style="opacity: 0.80">n</span><span style="opacity: 0.80">j</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80">y</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">i</span><span style="opacity: 0.80">t</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">h</span><span style="opacity: 0.80">e</span><span style="opacity: 0.80">r</span><span style="opacity: 0.80">e</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">a</span><span style="opacity: 0.80">n</span><span style="opacity: 0.80">d</span><span style="opacity: 0.80"> </span><span style="background-color: hsl(120, 100.00%, 60.00%); opacity: 1.00" title="11.242">l</span><span style="background-color: hsl(120, 100.00%, 60.00%); opacity: 1.00" title="11.242">o</span><span style="background-color: hsl(120, 100.00%, 60.00%); opacity: 1.00" title="11.242">n</span><span style="background-color: hsl(120, 100.00%, 60.00%); opacity: 1.00" title="11.242">d</span><span style="background-color: hsl(120, 100.00%, 60.00%); opacity: 1.00" title="11.242">o</span><span style="background-color: hsl(120, 100.00%, 60.00%); opacity: 1.00" title="11.242">n</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">t</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80">o</span> </p> <p style="margin-bottom: 0.5em; margin-top: 0em"> <b> y=New York </b> (probability <b>0.784</b>, score <b>1.287</b>)top features </p> <table class="eli5-weights" style="border-collapse: collapse; border: none; margin-top: 0em; margin-bottom: 2em;"> <thead> <tr style="border: none;"> <th style="padding: 0 1em 0 0.5em; text-align: right; border: none;">Weight</th> <th style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;">Feature</th> </tr> </thead> <tbody> <tr style="background-color: hsl(120, 100.00%, 95.32%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +1.084 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> Highlighted in text (sum) </td></tr> </tbody> </table> <p style="margin-bottom: 2.5em; margin-top:-0.5em;"> <span style="opacity: 0.80">h</span><span style="opacity: 0.80">e</span><span style="opacity: 0.80">l</span><span style="opacity: 0.80">l</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">s</span><span style="opacity: 0.80">i</span><span style="opacity: 0.80">m</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80">n</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">w</span><span style="opacity: 0.80">e</span><span style="opacity: 0.80">l</span><span style="opacity: 0.80">c</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80">m</span><span style="opacity: 0.80">e</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">t</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80"> </span><span style="background-color: hsl(120, 100.00%, 91.67%); opacity: 0.82" title="1.194">n</span><span style="background-color: hsl(120, 100.00%, 91.67%); opacity: 0.82" title="1.194">e</span><span style="background-color: hsl(120, 100.00%, 91.67%); opacity: 0.82" title="1.194">w</span><span style="opacity: 0.80"> </span><span style="background-color: hsl(120, 100.00%, 91.67%); opacity: 0.82" title="1.194">y</span><span style="background-color: hsl(120, 100.00%, 91.67%); opacity: 0.82" title="1.194">o</span><span style="background-color: hsl(120, 100.00%, 91.67%); opacity: 0.82" title="1.194">r</span><span style="background-color: hsl(120, 100.00%, 91.67%); opacity: 0.82" title="1.194">k</span><span style="opacity: 0.80">.</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">e</span><span style="opacity: 0.80">n</span><span style="opacity: 0.80">j</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80">y</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">i</span><span style="opacity: 0.80">t</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">h</span><span style="opacity: 0.80">e</span><span style="opacity: 0.80">r</span><span style="opacity: 0.80">e</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">a</span><span style="opacity: 0.80">n</span><span style="opacity: 0.80">d</span><span style="opacity: 0.80"> </span><span style="background-color: hsl(0, 100.00%, 94.23%); opacity: 0.81" title="-0.707">l</span><span style="background-color: hsl(0, 100.00%, 94.23%); opacity: 0.81" title="-0.707">o</span><span style="background-color: hsl(0, 100.00%, 94.23%); opacity: 0.81" title="-0.707">n</span><span style="background-color: hsl(0, 100.00%, 94.23%); opacity: 0.81" title="-0.707">d</span><span style="background-color: hsl(0, 100.00%, 94.23%); opacity: 0.81" title="-0.707">o</span><span style="background-color: hsl(0, 100.00%, 94.23%); opacity: 0.81" title="-0.707">n</span><span style="opacity: 0.80"> </span><span style="opacity: 0.80">t</span><span style="opacity: 0.80">o</span><span style="opacity: 0.80">o</span> </p> </div>

Note that the numbers here are exactly what we have seen above, but in addition we get a visual explanation of which words have trigged positive and negative signals. Moreover, with a bit of trickery to work around [this issue](https://github.com/TeamHG-Memex/eli5/issues/106), we can also dump the features computed for our model as a neatly looking heat map:

```python
setattr(clf.estimator, 'classes_', clf.classes_)
setattr(clf.estimator, 'coef_', clf.coef_)
setattr(clf.estimator, 'intercept_', clf.intercept_)
eli5.show_weights(clf.estimator, vec=vec, target_names=mlb.classes_)
```

<div class="output_html rendered_html output_subarea output_execute_result"> <table class="eli5-weights-wrapper" style="border-collapse: collapse; border: none; margin-bottom: 1.5em;"> <tbody><tr> <td style="padding: 0.5em; border: 1px solid black; text-align: center;"> <b> y=London </b>top features </td> <td style="padding: 0.5em; border: 1px solid black; text-align: center;"> <b> y=New York </b>top features </td> </tr> <tr> <td style="padding: 0px; border: 1px solid black; vertical-align: top;"> <table class="eli5-weights" style="border-collapse: collapse; border: none; margin-top: 0em; width: 100%;"> <thead> <tr style="border: none;"> <th style="padding: 0 1em 0 0.5em; text-align: right; border: none;">Weight</th> <th style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;">Feature</th> </tr> </thead> <tbody> <tr style="background-color: hsl(120, 100.00%, 80.00%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +25.340 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> london </td></tr> <tr style="background-color: hsl(120, 100.00%, 93.84%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +4.706 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> great </td></tr> <tr style="background-color: hsl(120, 100.00%, 96.53%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +2.079 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> lot london </td></tr> <tr style="background-color: hsl(120, 100.00%, 96.53%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +2.079 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> lot </td></tr> <tr style="background-color: hsl(120, 100.00%, 97.54%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +1.266 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> great britain </td></tr> <tr style="background-color: hsl(120, 100.00%, 97.54%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +1.266 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> britain </td></tr> <tr style="background-color: hsl(120, 100.00%, 98.07%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +0.896 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> museum </td></tr> <tr style="background-color: hsl(0, 100.00%, 97.01%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -1.682 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> new </td></tr> <tr style="background-color: hsl(0, 100.00%, 97.01%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -1.682 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> new york </td></tr> <tr style="background-color: hsl(0, 100.00%, 97.01%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -1.682 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> york </td></tr> <tr style="background-color: hsl(0, 100.00%, 95.80%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -2.723 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> nice </td></tr> <tr style="background-color: hsl(0, 100.00%, 95.36%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -3.143 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> &lt;BIAS&gt; </td></tr> <tr style="background-color: hsl(0, 100.00%, 94.63%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -3.875 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> apple </td></tr> <tr style="background-color: hsl(0, 100.00%, 94.63%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -3.875 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> big </td></tr> <tr style="background-color: hsl(0, 100.00%, 94.63%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -3.875 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> big apple </td></tr> <tr style="background-color: hsl(0, 100.00%, 94.30%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -4.219 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> nyc </td></tr> </tbody> </table> </td> <td style="padding: 0px; border: 1px solid black; vertical-align: top;"> <table class="eli5-weights" style="border-collapse: collapse; border: none; margin-top: 0em; width: 100%;"> <thead> <tr style="border: none;"> <th style="padding: 0 1em 0 0.5em; text-align: right; border: none;">Weight</th> <th style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;">Feature</th> </tr> </thead> <tbody> <tr style="background-color: hsl(120, 100.00%, 97.70%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +1.154 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> york </td></tr> <tr style="background-color: hsl(120, 100.00%, 97.70%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +1.154 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> new york </td></tr> <tr style="background-color: hsl(120, 100.00%, 97.70%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +1.154 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> new </td></tr> <tr style="background-color: hsl(120, 100.00%, 98.44%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +0.661 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> nyc </td></tr> <tr style="background-color: hsl(120, 100.00%, 98.64%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +0.546 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> nice </td></tr> <tr style="background-color: hsl(120, 100.00%, 98.67%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +0.526 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> big apple </td></tr> <tr style="background-color: hsl(120, 100.00%, 98.67%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +0.526 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> big </td></tr> <tr style="background-color: hsl(120, 100.00%, 98.67%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +0.526 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> apple </td></tr> <tr style="background-color: hsl(120, 100.00%, 99.32%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +0.202 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> &lt;BIAS&gt; </td></tr> <tr style="background-color: hsl(120, 100.00%, 99.75%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> +0.048 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> great </td></tr> <tr style="background-color: hsl(0, 100.00%, 98.72%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -0.500 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> lot </td></tr> <tr style="background-color: hsl(0, 100.00%, 98.72%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -0.500 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> lot london </td></tr> <tr style="background-color: hsl(0, 100.00%, 98.49%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -0.632 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> museum </td></tr> <tr style="background-color: hsl(0, 100.00%, 98.29%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -0.755 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> britain </td></tr> <tr style="background-color: hsl(0, 100.00%, 98.29%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -0.755 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> great britain </td></tr> <tr style="background-color: hsl(0, 100.00%, 97.12%); border: none;"> <td style="padding: 0 1em 0 0.5em; text-align: right; border: none;"> -1.594 </td> <td style="padding: 0 0.5em 0 0.5em; text-align: left; border: none;"> london </td></tr> </tbody> </table> </td> </tr> </tbody></table> </div>

So far, working with scikit-learn and eli5 is as fun as Transformers were when I was five! And working with a relatively large dataset is just as easy as the toy example shown here in. Man, this is great, but what about using it in a production system you say? Well, lets talk about that next time ;)
